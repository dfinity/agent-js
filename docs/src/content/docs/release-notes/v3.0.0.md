---
title: Release notes for v3.0.0
description: Release notes for the ICP JavaScript SDK v3.0.0.
---

This release marks a major update to the ICP JavaScript SDK, introducing several breaking changes, new features, and improvements. This guide is intended to help developers upgrade their projects to the latest version.

## Breaking Changes

### Removal of Management Canister from `@dfinity/agent`

The agent-js' implementation of the management canister actor was a duplicate of the one in the [`@dfinity/ic-management`](https://github.com/dfinity/ic-js/tree/main/packages/ic-management) package. It has been removed and you will need to update your code to use this package instead.

**Before:**

```typescript
import { getManagementCanister } from '@dfinity/agent';

const management = getManagementCanister({ agent });
```

**After:**

Use the [`@dfinity/ic-management`](https://github.com/dfinity/ic-js/tree/main/packages/ic-management) package.

### Use `Uint8Array` instead of `ArrayBuffer`

Internally, we have replaced the usage of `ArrayBuffer` with `Uint8Array`.

Specifically, all `@dfinity/candid` interfaces that previously accepted or returned `ArrayBuffer` now use `Uint8Array`. You will need to update your code to handle `Uint8Array` instead of `ArrayBuffer`.

**Before:**

```typescript
import { IDL } from '@dfinity/candid';

const myArgType = IDL.Text;
const myArgValue = 'Hello, world!';
const encoded: ArrayBuffer = IDL.encode([myArgType], [myArgValue]);
const decoded: [string] = IDL.decode([myArgType], encoded);
```

Or, with utility functions:

```typescript
import { concat } from '@dfinity/candid';

const buffer1: ArrayBuffer = ...;
const buffer2: ArrayBuffer = ...;
const combined: ArrayBuffer = concat(buffer1, buffer2);
```

**After:**

```typescript
import { IDL } from '@dfinity/candid';

const myArgType = IDL.Text;
const myArgValue = 'Hello, world!';
const encoded: Uint8Array = IDL.encode([myArgType], [myArgValue]);
const decoded: [string] = IDL.decode([myArgType], encoded);
```

Or, with utility functions:

```typescript
import { concat } from '@dfinity/candid';

const buffer1: Uint8Array = ...;
const buffer2: Uint8Array = ...;
const combined: Uint8Array = concat(buffer1, buffer2);
```

### Utility Function Replacements

The `fromHex`, `toHex`, and `concat` utility functions have been removed. Use the `bytesToHex`, `hexToBytes`, and `concatBytes` functions from `@noble/hashes/utils` instead.

**Before:**

```typescript
import { toHex, fromHex, concat } from '@dfinity/agent';

const hex = toHex(myUint8Array);
const bytes = fromHex(myHexString);
const combined = concat(buffer1, buffer2);
```

**After:**

```typescript
import { bytesToHex, hexToBytes, concatBytes } from '@noble/hashes/utils';

const hex = bytesToHex(myUint8Array);
const bytes = hexToBytes(myHexString);
const combined = concatBytes(buffer1, buffer2);
```

### New `AgentError` Error and Better Error Handling

Several specific error classes have been removed in favor of a new, more generic `AgentError`. This new error class has the following properties:

- `code`: an `ErrorCode` class value, e.g. `CertifiedRejectErrorCode`. See [`errors.ts`](https://github.com/dfinity/agent-js/blob/e7e371b5399d44ea387f21cdcb0e195af4bef2b9/packages/agent/src/errors.ts) for all error codes.
- `kind`: an `ErrorKindEnum` enum value, e.g. `ErrorKindEnum.Trust`. See [`ErrorKindEnum`](https://github.com/dfinity/agent-js/blob/e7e371b5399d44ea387f21cdcb0e195af4bef2b9/packages/agent/src/errors.ts#L9-L18) for all error kinds.
- [`message`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/message): a human-readable error message
- [`cause`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error/cause): an object containing the `code` and `kind` properties

This new error class is more flexible and easier to handle in your code.

The removed error classes are:

- `AgentHTTPResponseError`
- `AgentCallError`
- `AgentQueryError`
- `AgentReadStateError`
- `CertificateVerificationError`
- `ActorCallError`
- `QueryCallRejectedError`
- `UpdateCallRejectedError`

You should update your error handling logic to catch `AgentError` and inspect its properties.

**Example:**

```typescript
try {
  // agent call
} catch (e) {
  if (e instanceof AgentError) {
    console.error(e.message);
    if (
      e.code instanceof CertifiedRejectErrorCode && // or e.cause.code
      e.kind === ErrorKindEnum.Trust // or e.cause.kind
    ) {
      // do something
    }
  }
}
```

### Removal of `defaultAgent`

The global `defaultAgent` concept and the `getDefaultAgent` function have been removed. The `HttpAgent` constructor is now the only way to create an agent.

**Before:**

```typescript
import { getDefaultAgent } from '@dfinity/agent';

const agent = getDefaultAgent();
```

**After:**

```typescript
import { HttpAgent } from '@dfinity/agent';

const agent = await HttpAgent.create(); // or use the synchronous version `HttpAgent.createSync()`
```

### Removal of `ProxyAgent`

The `ProxyAgent` class has been removed. You should use the `HttpAgent` class instead.

### `Expiry` Class Refactor

The `Expiry` class has been refactored to use static factory methods and no longer exposes a public constructor. It also now supports JSON serialization/deserialization.

**Before:**

```typescript
import { Expiry } from '@dfinity/agent';

// This is a simplified example of what might have been done,
// though direct instantiation was often internal.
const fiveMinutes = 5 * 60 * 1000;
const expiry = new Expiry(fiveMinutes);
```

**After:**

```typescript
import { Expiry } from '@dfinity/agent';

// Create an expiry 5 minutes from now.
const fiveMinutes = 5 * 60 * 1000;
const expiry = Expiry.fromDeltaInMilliseconds(fiveMinutes);

// You can also serialize and deserialize Expiry objects.
const json = expiry.toJSON();
const expiryFromJson = Expiry.fromJSON(JSON.stringify(json));
```

### Certificate Method Renaming and Removal

- The `lookup` method of the `Certificate` class has been renamed to `lookup_path` to align with the [IC Interface Specification](https://github.com/dfinity/portal/blob/8015a4ab50232176723ffd95e32a02f1bf7fef30/docs/references/ic-interface-spec.md?plain=1#L3069).
- The `lookup_label` method has been removed from the `Certificate` class. Use `lookup_path` instead.
- The `lookup_subtree` method has been introduced both as a standalone function and as a method of the `Certificate` class.

**Before:**

```typescript
const result = certificate.lookup(['a', 'b']);
const label = certificate.lookup_label(['path', 'to', 'label']);
```

**After:**

```typescript
// Lookup a path
const result = certificate.lookup_path(['a', 'b']);
const label = certificate.lookup_path(['path', 'to', 'label']);

// Additionally, you can now lookup subtrees.
// Lookup a subtree, with the new lookup_subtree function
const subnetLookupResult = lookup_subtree(
  ['subnet', delegation.subnet_id, 'node'],
  certificate.tree,
);

// Lookup a subtree, with the new lookup_subtree method
const subnetLookupResult = certificate.lookup_subtree(['subnet', delegation.subnet_id, 'node']);
```

### Hashing Function Replacement

The `hash` function has been removed. Use the `sha256` function from `@noble/hashes/sha2` instead.

**Before:**

```typescript
import { hash } from '@dfinity/agent';

const hashed = hash(myBuffer);
```

**After:**

```typescript
import { sha256 } from '@noble/hashes/sha2';

const hashed = sha256(myBuffer);
```

### Cbor package replacement

The `@dfinity/agent` package now uses [`@dfinity/cbor`](https://npmjs.com/package/@dfinity/cbor) instead of the `borc` and `simple-cbor` dependencies, reducing the bundle size of most packages [by at least 30% (gzipped) ðŸ¤¯](https://github.com/dfinity/agent-js/pull/1015#issuecomment-2912381841).

**Before:**

```typescript
import { Cbor } from '@dfinity/agent';

const encoded: ArrayBuffer = Cbor.encode(myValue);
const decoded: MyType = Cbor.decode(encoded);
```

**After:**

```typescript
import { Cbor } from '@dfinity/agent';

const encoded: Uint8Array = Cbor.encode(myValue); // now returns Uint8Array
const decoded = Cbor.decode<MyType>(encoded); // now accepts Uint8Array
```

### Node.js Version Support

Support for Node.js v19 and lower, and Node.js v21 has been dropped. Please ensure you are using a supported version of Node.js (LTS versions like 20 or 22 are recommended).

## New Features

- **Improved Polling Strategy**: The polling strategy for `read_state` requests has been changed to support presigned requests. A new `preSignReadStateRequest` option allows for a single signature to be used for all polling requests, which is beneficial for hardware wallets.

## Fixes and Improvements

- **Removed Watermark Check for Query Responses**: The agent no longer checks for watermarks on query responses. It now checks if the node signature is not older than the `ingressExpiryInMinutes` option, taking into account clock drift, to prevent stale query responses.
- **Dependency Updates**: `@noble/*` dependencies have been updated. Old unused dependencies have been removed.
- **`@noble/hashes` Dependency**: `@noble/hashes` is now correctly marked as a dependency.
- **Clock Drift Calculation**: The clock drift is now always accounted for when calculating the ingress expiry.
- **Candid Subtyping**: Subtyping relationships are now checked when decoding function or service references, improving compliance with the Candid spec and reducing the risk of calling services with incorrect argument types.
- **Request Retries**: Requests that fail due to a malformed response body will now be retried.
- **`isAuthenticated` Fix**: `AuthClient.isAuthenticated` now correctly returns `false` if the delegation chain is invalid (e.g., due to an expired session).
